apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "orthanc-oauth.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "orthanc-oauth.labels" . | nindent 4 }}
data:
  # Orthanc core configuration
  orthanc.json: |
    {
      "Name": "{{ .Values.orthanc.dicomAet }}",
      "RemoteAccessAllowed": {{ .Values.orthanc.remoteAccessAllowed }},
      "AuthenticationEnabled": {{ .Values.orthanc.authenticationEnabled }},
      {{- if .Values.orthanc.registeredUsers }}
      "RegisteredUsers": {{ .Values.orthanc.registeredUsers | toJson }},
      {{- end }}
      "HttpPort": {{ .Values.orthanc.httpPort }},
      "HttpCompressionEnabled": {{ .Values.orthanc.httpCompression }},
      "HttpThreadsCount": {{ .Values.orthanc.httpThreadsCount }},
      "DicomAet": "{{ .Values.orthanc.dicomAet }}",
      "DicomPort": {{ .Values.orthanc.dicomPort }},
      "DicomThreadsCount": {{ .Values.orthanc.dicomThreadsCount }},
      "Plugins": ["/etc/orthanc/plugins/dicomweb_oauth_plugin.py"]
    }

  # OAuth plugin configuration
  dicomweb-oauth.json: |
    {{- $servers := dict }}
    {{- range $name, $server := .Values.oauthPlugin.servers }}
    {{- $serverConfig := dict }}
    {{- $_ := set $serverConfig "Url" $server.url }}
    {{- $_ := set $serverConfig "TokenEndpoint" $server.tokenEndpoint }}
    {{- $_ := set $serverConfig "Scope" $server.scope }}
    {{- $_ := set $serverConfig "TokenRefreshBufferSeconds" (default 300 $server.tokenRefreshBufferSeconds) }}
    {{- $_ := set $serverConfig "VerifySSL" true }}
    {{- if eq $server.authentication.type "client-credentials" }}
    {{- $_ := set $serverConfig "ClientId" "${OAUTH_CLIENT_ID}" }}
    {{- $_ := set $serverConfig "ClientSecret" "${OAUTH_CLIENT_SECRET}" }}
    {{- else if eq $server.authentication.type "workload-identity" }}
    {{- $_ := set $serverConfig "UseManagedIdentity" true }}
    {{- end }}
    {{- $_ := set $servers $name $serverConfig }}
    {{- end }}
    {{- $config := dict "DicomWebOAuth" (dict "ConfigVersion" "2.0" "LogLevel" .Values.oauthPlugin.logLevel "RateLimitRequests" .Values.oauthPlugin.rateLimitRequests "RateLimitWindowSeconds" .Values.oauthPlugin.rateLimitWindowSeconds "Servers" $servers) }}
    {{- $config | toJson }}
