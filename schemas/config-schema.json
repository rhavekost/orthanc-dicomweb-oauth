{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Orthanc DICOMweb OAuth Configuration",
  "description": "JSON Schema for validating DICOMweb OAuth plugin configuration",
  "type": "object",
  "required": ["DicomWebOAuth"],
  "properties": {
    "ConfigVersion": {
      "type": "string",
      "enum": ["2.0"],
      "description": "Configuration schema version"
    },
    "DicomWebOAuth": {
      "type": "object",
      "required": ["Servers"],
      "properties": {
        "Servers": {
          "type": "object",
          "minProperties": 1,
          "additionalProperties": {
            "$ref": "#/definitions/ServerConfig"
          }
        },
        "RateLimitRequests": {
          "type": "integer",
          "minimum": 1,
          "default": 10,
          "description": "Maximum requests per time window"
        },
        "RateLimitWindowSeconds": {
          "type": "integer",
          "minimum": 1,
          "default": 60,
          "description": "Rate limit time window in seconds"
        }
      }
    }
  },
  "definitions": {
    "ServerConfig": {
      "type": "object",
      "required": ["Url"],
      "properties": {
        "Url": {
          "type": "string",
          "format": "uri",
          "pattern": "^https?://",
          "description": "DICOMweb server URL"
        },
        "TokenEndpoint": {
          "type": "string",
          "format": "uri",
          "pattern": "^https?://",
          "description": "OAuth2 token endpoint URL"
        },
        "ClientId": {
          "type": "string",
          "minLength": 1,
          "description": "OAuth2 client ID"
        },
        "ClientSecret": {
          "type": "string",
          "minLength": 1,
          "description": "OAuth2 client secret"
        },
        "Scope": {
          "type": "string",
          "description": "OAuth2 scope"
        },
        "VerifySSL": {
          "type": "boolean",
          "default": true,
          "description": "Verify SSL certificates"
        },
        "TokenRefreshBufferSeconds": {
          "type": "integer",
          "minimum": 0,
          "maximum": 3600,
          "default": 300,
          "description": "Token refresh buffer in seconds"
        },
        "ProviderType": {
          "type": "string",
          "enum": ["auto", "azure", "google", "keycloak", "generic", "aws", "azuremanagedidentity"],
          "default": "auto",
          "description": "OAuth provider type"
        },
        "JWTPublicKey": {
          "type": "string",
          "description": "Public key in PEM format for JWT signature validation"
        },
        "JWTAudience": {
          "type": "string",
          "description": "Expected JWT audience claim"
        },
        "JWTIssuer": {
          "type": "string",
          "description": "Expected JWT issuer claim"
        },
        "JWTAlgorithms": {
          "oneOf": [
            {
              "type": "string",
              "description": "Single JWT signing algorithm"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Allowed JWT signing algorithms"
            }
          ]
        },
        "ResilienceConfig": {
          "type": "object",
          "properties": {
            "CircuitBreakerEnabled": {
              "type": "boolean",
              "description": "Enable circuit breaker pattern for resilience"
            },
            "CircuitBreakerFailureThreshold": {
              "type": "integer",
              "minimum": 1,
              "description": "Number of failures before circuit opens"
            },
            "CircuitBreakerTimeout": {
              "type": "number",
              "minimum": 0,
              "description": "Time in seconds before circuit tries to close"
            },
            "RetryMaxAttempts": {
              "type": "integer",
              "minimum": 1,
              "description": "Maximum number of retry attempts"
            },
            "RetryStrategy": {
              "type": "string",
              "enum": ["fixed", "linear", "exponential"],
              "description": "Retry backoff strategy"
            },
            "RetryInitialDelay": {
              "type": "number",
              "minimum": 0,
              "description": "Initial delay in seconds for retry"
            },
            "RetryMultiplier": {
              "type": "number",
              "minimum": 1,
              "description": "Multiplier for exponential backoff"
            },
            "RetryMaxDelay": {
              "type": "number",
              "minimum": 0,
              "description": "Maximum delay in seconds for retry"
            },
            "RetryIncrement": {
              "type": "number",
              "minimum": 0,
              "description": "Increment in seconds for linear backoff"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false,
      "if": {
        "properties": {
          "ProviderType": { "const": "azuremanagedidentity" }
        },
        "required": ["ProviderType"]
      },
      "then": {
        "required": ["Url", "Scope"]
      },
      "else": {
        "required": ["Url", "TokenEndpoint", "ClientId", "ClientSecret"]
      }
    }
  }
}
